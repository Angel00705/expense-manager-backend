const mongoose = require('mongoose');
const IP = require('../models/IP');
const Card = require('../models/Card');

async function importCards() {
  try {
    console.log('ðŸ”„ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ ÐºÐ°Ñ€Ñ‚ Ð¸Ð· CSV...');

    // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
    await Card.deleteMany({});
    await IP.deleteMany({});
    console.log('âœ… Ð¡Ñ‚Ð°Ñ€Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ñ‹');

    const csvData = `
Ð˜ÐŸ / Ð Ð•Ð“Ð˜ÐžÐ,,ÐšÐ¾Ñ€Ð¿. ÐºÐ°Ñ€Ñ‚Ð°,ÐšÐ°Ñ€Ñ‚Ð° Ð¤Ð›,ÐžÐºÑ‚ÑÐ±Ñ€ÑŒ 2025,
,,,,ÐšÐ¾Ñ€Ð¿. ÐºÐ°Ñ€Ñ‚Ð°,ÐšÐ°Ñ€Ñ‚Ð° Ð¤Ð›
Ð˜ÐŸ ÐšÑ€ÑƒÑ‚Ð¾ÑƒÑÐ¾Ð²,ÐÑÑ‚Ñ€Ð°Ñ…Ð°Ð½ÑŒ,*3420,*7367,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ Ð¥Ñ€Ð°Ð¼Ð¾Ð²Ð°,,*5049,*4455,Ð’ ÐŸÐ’Ð— ÐÐ°Ð»Ð¸Ð²Ð°Ð¹ÐºÐ¾,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð¯Ð½Ð³Ð°Ð»Ñ‹ÑˆÐµÐ²Ð° Ð.,,*2468,*9647,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ ÐÐÐ›Ð˜Ð’ÐÐ™ÐšÐž,,*8098,-,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ ÐšÐÐ¨Ð˜Ð Ð˜Ð Ð’.Ð“.,,*7969,-,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ ÐÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ ÐÑ€Ð°Ð·,Ð‘ÑƒÑ€ÑÑ‚Ð¸Ñ (Ð£Ð›ÐÐ-Ð£Ð”Ð­),*7651,--,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ ÐŸÐ¸Ð½ÐµÐ³Ð¸Ð½,,,*3475,,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð Ð¾Ð²Ð´Ð° Ð.Ð®.,,*8829,*5833,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð˜Ð›Ð¬Ð•ÐÐšÐž,,*8325,*5865,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,ÐŸÐµÑ€ÐµÐ²Ñ‹Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ
Ð˜ÐŸ Ð‘Ð¾Ð½Ð´Ð°Ñ€ÐµÐ½ÐºÐ¾ Ð›.Ð˜. ,ÐšÑƒÑ€Ð³Ð°Ð½,*7254,*5664,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð‘Ð¾Ð±ÐºÐ¾Ð²,,*1381,*2911,Ð’ ÐŸÐ’Ð— ÐžÐ²ÑÐµÐ¹ÐºÐ¾,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð”ÑŽÐ»ÑŒÐ³ÐµÑ€,,*9895,--,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ Ð¤ÐµÐ´Ñ‡ÑƒÐº,,*9967,--,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ ÐšÐÐ Ð‘Ð«Ð¨Ð•Ð’,,*2937,--,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ ÐžÐ’Ð¡Ð•Ð™ÐšÐž,,*1946,--,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ Ð Ð¯Ð‘Ð•ÐÐšÐž Ð˜.Ð˜,,-,*6532,,
,,,*7611,,Ð£ ÐÐ¸ÐºÐ¸Ñ‚Ñ‹ Ð .
Ð˜ÐŸ Ð˜Ð±Ñ€Ð°Ð³Ð¸Ð¼Ð¾Ð² Ð¨,ÐšÐ°Ð»Ð¼Ñ‹ÐºÐ¸Ñ (Ð­Ð›Ð˜Ð¡Ð¢Ð),*5109,*7068,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ ÐÐ¸ÐºÐ¸Ñ„Ð¾Ñ€Ð¾Ð²Ð°,,*4821,*5341,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð¯Ñ€Ð¾ÑÐ»Ð°Ð²Ñ†ÐµÐ² Ð“.Ð’.,,*7570,--,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ Ð˜Ð²Ð°Ð½Ð¾Ð²,ÐœÐ¾Ñ€Ð´Ð¾Ð²Ð¸Ñ (Ð¡ÐÐ ÐÐÐ¡Ðš),*7184,*3487,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ñ…,,*8701,--,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
Ð˜ÐŸ Ð¯ÐºÐ¾Ð²Ð»ÐµÐ²Ð°,,*4679,*0952,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð‘Ð°Ð´Ð°Ð»Ð¾Ð²,Ð£Ð´Ð¼ÑƒÑ€Ñ‚Ð¸Ñ (Ð˜Ð–Ð•Ð’Ð¡Ðš),,*8406,,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð•Ð¼ÐµÐ»ÑŒÑÐ½Ð¾Ð² Ð“. Ð˜.,,*4454,*7289,Ð’ ÐŸÐ’Ð— Ð›ÐµÐ¾Ð½Ð³Ð°Ñ€Ð´,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð›ÐµÐ¾Ð½Ð³Ð°Ñ€Ð´,,*1749,*9648,Ð’ ÐŸÐ’Ð— Ð•Ð¼ÐµÐ»ÑŒÑÐ½Ð¾Ð²,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð¡Ð°Ð¸Ð½Ð¾Ð²Ð°,,*5313,*0628,Ð’ ÐŸÐ’Ð— Ð¨ÐµÑ„ÐµÑ€,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð¡Ð°Ð¼ÑÐ¾Ð½Ð¾Ð² Ð.Ð”.,,*5995,*3500,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ
Ð˜ÐŸ Ð¨ÐµÑ„ÐµÑ€,,*1767,,Ð² Ñ€ÐµÐ³Ð¸Ð¾Ð½Ðµ,
`.trim();

    const lines = csvData.split('\n').slice(2); // ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸
    let currentRegion = '';
    let importedCount = 0;

    for (const line of lines) {
      const columns = line.split(',').map(col => col.trim());
      
      const ipName = columns[0];
      const region = columns[1] || currentRegion;
      const corpCard = columns[2];
      const personalCard = columns[3];
      const corpStatus = columns[4];
      const personalStatus = columns[5];

      if (region) currentRegion = region;
      if (!ipName) continue;

      try {
        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð˜ÐŸ
        let ip = await IP.findOne({ name: ipName, region });
        if (!ip) {
          ip = await IP.create({ name: ipName, region });
        }

        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½ÑƒÑŽ ÐºÐ°Ñ€Ñ‚Ñƒ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
        if (corpCard && corpCard !== '-' && corpCard !== '--') {
          await Card.create({
            ipId: ip._id,
            type: 'corp',
            numberMask: corpCard,
            status: corpStatus || '',
            months: {
              'ÐžÐºÑ‚ÑÐ±Ñ€ÑŒ 2025': {
                corporate: corpStatus || null
              }
            }
          });
          importedCount++;
        }

        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ ÐºÐ°Ñ€Ñ‚Ñƒ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
        if (personalCard && personalCard !== '-' && personalCard !== '--') {
          await Card.create({
            ipId: ip._id,
            type: 'personal',
            numberMask: personalCard,
            status: personalStatus || '',
            months: {
              'ÐžÐºÑ‚ÑÐ±Ñ€ÑŒ 2025': {
                personal: personalStatus || null
              }
            }
          });
          importedCount++;
        }

      } catch (error) {
        console.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð° Ð´Ð»Ñ ${ipName}:`, error.message);
      }
    }

    console.log(`âœ… Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½! Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ ${importedCount} ÐºÐ°Ñ€Ñ‚`);
    return { success: true, imported: importedCount };
    
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð°:', error);
    return { success: false, error: error.message };
  }
}

// Ð•ÑÐ»Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
if (require.main === module) {
  require('dotenv').config();
  mongoose.connect(process.env.MONGODB_URI)
    .then(() => importCards())
    .then(() => mongoose.disconnect())
    .catch(console.error);
}

module.exports = importCards;
