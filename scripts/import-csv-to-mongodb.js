const mongoose = require('mongoose');
const IP = require('../models/IP');
const Card = require('../models/Card');

async function importCards() {
  try {
    console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç –∫–∞—Ä—Ç –∏–∑ CSV...');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    if (mongoose.connection.readyState !== 1) {
      throw new Error('MongoDB –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
    }

    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
    await Card.deleteMany({});
    await IP.deleteMany({});
    console.log('‚úÖ –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');

    const csvData = `
–ò–ü / –†–ï–ì–ò–û–ù,,–ö–æ—Ä–ø. –∫–∞—Ä—Ç–∞,–ö–∞—Ä—Ç–∞ –§–õ,–û–∫—Ç—è–±—Ä—å 2025,
,,,,–ö–æ—Ä–ø. –∫–∞—Ä—Ç–∞,–ö–∞—Ä—Ç–∞ –§–õ
–ò–ü –ö—Ä—É—Ç–æ—É—Å–æ–≤,–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å,*3420,*7367,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –•—Ä–∞–º–æ–≤–∞,,*5049,*4455,–í –ü–í–ó –ù–∞–ª–∏–≤–∞–π–∫–æ,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –Ø–Ω–≥–∞–ª—ã—à–µ–≤–∞ –ê.,,*2468,*9647,–≤ —Ä–µ–≥–∏–æ–Ω–µ,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –ù–ê–õ–ò–í–ê–ô–ö–û,,*8098,-,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –ö–ê–®–ò–†–ò–ù –í.–ì.,,*7969,-,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –ê—Å—Ç–∞–Ω–æ–≤–∏ –ê—Ä–∞–∑,–ë—É—Ä—è—Ç–∏—è (–£–õ–ê–ù-–£–î–≠),*7651,--,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –ü–∏–Ω–µ–≥–∏–Ω,,,*3475,,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –†–æ–≤–¥–∞ –ê.–Æ.,,*8829,*5833,–≤ —Ä–µ–≥–∏–æ–Ω–µ,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –ò–õ–¨–ï–ù–ö–û,,*8325,*5865,–≤ —Ä–µ–≥–∏–æ–Ω–µ,–ü–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç—å
–ò–ü –ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ –õ.–ò. ,–ö—É—Ä–≥–∞–Ω,*7254,*5664,–≤ —Ä–µ–≥–∏–æ–Ω–µ,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –ë–æ–±–∫–æ–≤,,*1381,*2911,–í –ü–í–ó –û–≤—Å–µ–π–∫–æ,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –î—é–ª—å–≥–µ—Ä,,*9895,--,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –§–µ–¥—á—É–∫,,*9967,--,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –ö–ê–†–ë–´–®–ï–í,,*2937,--,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –û–í–°–ï–ô–ö–û,,*1946,--,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –†–Ø–ë–ï–ù–ö–û –ò.–ò,,-,*6532,,
,,,*7611,,–£ –ù–∏–∫–∏—Ç—ã –†.
–ò–ü –ò–±—Ä–∞–≥–∏–º–æ–≤ –®,–ö–∞–ª–º—ã–∫–∏—è (–≠–õ–ò–°–¢–ê),*5109,*7068,–≤ —Ä–µ–≥–∏–æ–Ω–µ,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –ù–∏–∫–∏—Ñ–æ—Ä–æ–≤–∞,,*4821,*5341,–≤ —Ä–µ–≥–∏–æ–Ω–µ,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –Ø—Ä–æ—Å–ª–∞–≤—Ü–µ–≤ –ì.–í.,,*7570,--,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –ò–≤–∞–Ω–æ–≤,–ú–æ—Ä–¥–æ–≤–∏—è (–°–ê–†–ê–ù–°–ö),*7184,*3487,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –ö–æ—Ä–æ—Ç–∫–∏—Ö,,*8701,--,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
–ò–ü –Ø–∫–æ–≤–ª–µ–≤–∞,,*4679,*0952,–≤ —Ä–µ–≥–∏–æ–Ω–µ,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –ë–∞–¥–∞–ª–æ–≤,–£–¥–º—É—Ä—Ç–∏—è (–ò–ñ–ï–í–°–ö),,*8406,,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –ï–º–µ–ª—å—è–Ω–æ–≤ –ì. –ò.,,*4454,*7289,–í –ü–í–ó –õ–µ–æ–Ω–≥–∞—Ä–¥,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –õ–µ–æ–Ω–≥–∞—Ä–¥,,*1749,*9648,–í –ü–í–ó –ï–º–µ–ª—å—è–Ω–æ–≤,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –°–∞–∏–Ω–æ–≤–∞,,*5313,*0628,–í –ü–í–ó –®–µ—Ñ–µ—Ä,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –°–∞–º—Å–æ–Ω–æ–≤ –ê.–î.,,*5995,*3500,–≤ —Ä–µ–≥–∏–æ–Ω–µ,–≤ —Ä–µ–≥–∏–æ–Ω–µ
–ò–ü –®–µ—Ñ–µ—Ä,,*1767,,–≤ —Ä–µ–≥–∏–æ–Ω–µ,
`.trim();

    const lines = csvData.split('\n').slice(2);
    let currentRegion = '';
    let importedCount = 0;

    for (const line of lines) {
      const columns = line.split(',').map(col => col.trim());
      
      const ipName = columns[0];
      const region = columns[1] || currentRegion;
      const corpCard = columns[2];
      const personalCard = columns[3];
      const corpStatus = columns[4];
      const personalStatus = columns[5];

      if (region) currentRegion = region;
      if (!ipName) continue;

      try {
        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –ò–ü
        let ip = await IP.findOne({ name: ipName, region });
        if (!ip) {
          ip = await IP.create({ name: ipName, region });
        }

        // –°–æ–∑–¥–∞–µ–º –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
        if (corpCard && corpCard !== '-' && corpCard !== '--') {
          await Card.create({
            ipId: ip._id,
            type: 'corp',
            numberMask: corpCard,
            status: corpStatus || '',
            months: {
              '–û–∫—Ç—è–±—Ä—å 2025': {
                corporate: corpStatus || null
              }
            }
          });
          importedCount++;
        }

        // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
        if (personalCard && personalCard !== '-' && personalCard !== '--') {
          await Card.create({
            ipId: ip._id,
            type: 'personal',
            numberMask: personalCard,
            status: personalStatus || '',
            months: {
              '–û–∫—Ç—è–±—Ä—å 2025': {
                personal: personalStatus || null
              }
            }
          });
          importedCount++;
        }

      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–ª—è ${ipName}:`, error.message);
      }
    }

    console.log(`‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –î–æ–±–∞–≤–ª–µ–Ω–æ ${importedCount} –∫–∞—Ä—Ç`);
    return { success: true, imported: importedCount };
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
    return { success: false, error: error.message };
  }
}

module.exports = importCards;
